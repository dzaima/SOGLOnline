<!DOCTYPE html>
<meta charset="UTF-8">
<head>
  <link rel="stylesheet" href="style.css">
</head>
<html>
<head>
    <title>SOGL interpreter</title>
    <script src="processing.js"></script>
    <script src="bigDecimal.js"></script>
</head>
<body style="background: #f5fff5;">
  <canvas data-processing-sources="compiled.pde" height=1 width=1></canvas>
  <center><H1>SOGL interpreter</H1></center>
  <div id="all">
    <div id="left">
      <div id="p" style="width:40%;"><span id="bytecount" style="font-size:12px">0 bytes</span></div><div id="p" style="width:20%;"><center><b>CODE</b></center></div>
      <textarea id="program" placeholder="Enter code..." spellcheck="false" onclick="setTimeout(update, 1);" oninput="setTimeout(update, 1);"></textarea>
    </div>
    <div id="right" align="right">
      <center><b>INPUTS</b></center>
      <textarea id="inputs" placeholder="Enter inputs in each line" spellcheck="false" style="width:100%"></textarea>
    </div>
    <textarea id="output" style="width: 100%; height:300px" placeholder="Output will appear here once some code has been executed" readonly></textarea>
    <br/>
    <div id="p" style="width:220px">
      <button onclick="runClicked()" style="width:47%">run</button>
      <button onclick="permalink()" style="width:47%; float:right;">permalink</button>
    </div>
    <br>
    <div id="p" style="width:220px">
      <input type="button" id="loadSOGL" value="load SOGL codepage encoded file" onclick="loadSOGL()"; style="width:100%"></input>
      <br/>
    <input type="button" id="saveSOGL" value="save SOGL codepage encoded file" onclick="saveSOGL();" style="width:100%"></input>
    </div>
    <div id="p">
      <input type="file" id="fileinput" accept=".soglbin"/>
      <br>
      <a id="savedLink"></a>
    </div>
  </div>
  <script>
    var soglOS = "";
    var cp;
    var ALLCHARS = "⁰¹²³⁴⁵⁶⁷⁸\t\n⁹±∑«»æÆø‽§°¦‚‛⁄¡¤№℮½← !\"#$%&'()*+,-./0123456789:;<=>?@ABCDEFGHIJKLMNOPQRSTUVWXYZ[\\]^_`abcdefghijklmnopqrstuvwxyz{|}~↑↓≠≤≥∞√═║─│≡∙∫○׀′¬⁽⁾⅟‰÷╤╥ƨƧαΒβΓγΔδΕεΖζΗηΘθΙιΚκΛλΜμΝνΞξΟοΠπΡρΣσΤτΥυΦφΧχΨψΩωāčēģīķļņōŗšūž¼¾⅓⅔⅛⅜⅝⅞↔↕∆≈┌┐└┘╬┼╔╗╚╝░▒▓█▲►▼◄■□…‼⌠⌡¶→“”‘’";
    var pobj = document.getElementById("program");
    var args = location.search.substring(1).split(",");
    document.onkeydown = update;
    for (var i = 0; i < args.length; i++) {
      var carg = args[i];
      if (carg.startsWith("code="))
        pobj.value = unescape(atob(carg.substring(5).replace(/_/g, "=")));
      if (carg.startsWith("inputs="))
        document.getElementById("inputs").value = unescape(atob(carg.substring(7).replace(/_/g, "=")));
    }
    function runClicked() {
      if (!cp) cp = Processing.instances[0];
      soglOS = "";
      var prog = pobj.value;
      var inps = document.getElementById("inputs").value;
      cp.launchSOGL(prog, inps.split("\n"));
      document.getElementById("output").value = soglOS;
    }
    
    function update() {
      var bytecount = pobj.value.length;
      var startPos = pobj.selectionStart;
      var endPos = pobj.selectionEnd;
      var co = bytecount +" byte"+ (bytecount==1? "" : "s");
      if (endPos != startPos)
        co+= " ("+ (endPos-startPos) +" byte"+ (endPos-startPos==1? "" : "s") +" selected)"
      document.getElementById("bytecount").innerHTML = co;
      //console.log(startPos+" "+endPos);
    }
    
    function permalink() {
      var res = location.href.substring(0,location.href.length-location.search.length)+"?";
      res+= "code="+ (btoa(escape(pobj.value)).replace(/=/g, "_"));
      var inputs = document.getElementById("inputs").value;
      if (inputs != "")
        res+= ",inputs="+ btoa(escape(inputs)).replace(/=/g, "_");
      document.getElementById("output").value = res;
    }
    function saveSOGL() {
      if (!cp) cp = Processing.instances[0];
      var link = document.getElementById("savedLink");
      var prog = pobj.value;
      link.download = "encoded.soglbin";
      var progBin = "";
      for (var i = 0; i < prog.length; i++) {
        progBin+= String.fromCodePoint(ALLCHARS.indexOf(prog.charAt(i)));
      }
      link.href = 'data:text/plain;base64,' + btoa(progBin);
      link.click();
    }
    
    var fr;
    function loadSOGL() {
      var f = document.getElementById('fileinput').files[0];
      fr = new FileReader();
      fr.onload = recieved;
      fr.readAsBinaryString(f);
    }
    function recieved() {
      if (!cp) cp = Processing.instances[0];
      var progbin = fr.result;
      var prog = "";
      for (var i = 0; i < progbin.length; i++) {
        prog+= ALLCHARS.charAt(progbin.charCodeAt(i));
      }
      pobj.value = prog;
      update();
    }
    update();
  </script>
</body>
</html>
